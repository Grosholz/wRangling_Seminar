---
title: "Datetimes & Time Series"
author: "Ryan Peek"
date: "Updated: `r format(Sys.Date())`"
output:
  github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("../"))
```

Since we didn't really get to the datetime stuff last lesson, let's dive straight in here. 

## Datetimes (aka Insanity)

First, please read:

 - this lesson on [dates & spreadsheets](http://www.datacarpentry.org/spreadsheet-ecology-lesson/03-dates-as-data.html)
 - https://www.stat.berkeley.edu/~s133/dates.html
 - https://cran.r-project.org/web/packages/lubridate/vignettes/lubridate.html
 - http://www.noamross.net/blog/2014/2/10/using-times-and-dates-in-r---presentation-code.html

Various commands and functions available. There are **3** basic time classes in R:

 - Dates (just dates, i.e., 2012-02-10)
 - POSIXct ("**ct**" == calendar time, best class for dates with times)
 - POSIXlt ("**lt**" == local time, enables easy extraction of specific componants of a time, however, remember that POXIXlt objects are lists)

### Working with Dates

 - `as.Date("2016-01-01")` = `r as.Date("2016-01-01")`
 - `lubridate::ymd("2016-01-01")` or `lubridate::mdy` or `lubridate::dmy` = `r lubridate::ymd("2016-01-01")`

### Working with Datetimes & Timezones
 
 - `as.POSIXct("2016-01-01 12:00", "UTC")` = `r as.POSIXct("2016-01-01 12:00", "UTC")`
 - `strptime("2016/01/01 12:00",format = "%Y/%m/%d %H:%M")` = `r strptime("2016/01/01 12:00",format = "%Y/%m/%d %H:%M")`
 - `lubridate::ymd_hms("2016/01/01 21:22:22")` = `r lubridate::ymd_hms("2016/01/01 21:22:22")`
 - `lubridate::ymd_hms("20160101 21:22:22")` = `r lubridate::ymd_hms("20160101 21:22:22")`
 - `lubridate::ymd_hms("2016-01-01 21:22:22", tz = "America/Los_Angeles")` = `r lubridate::ymd_hms("2016-01-01 21:22:22", tz = "America/Los_Angeles")`

### Datetimes without Timezones (and `chron`)

The `chron` package may be helpful for these tasks, however, this may also be a suitable use of the POSIXlt class.

 - `chron::as.chron("2013-07-24 23:55:26")` = `r chron::as.chron("2013-07-24 23:55:26")`
 - `chron::as.chron("07/25/13 08:32:07", "%m/%d/%y %H:%M:%S")` = `r chron::as.chron("07/25/13 08:32:07", "%m/%d/%y %H:%M:%S")`

### Using the `lubridate` package

```{r lubridate basics}
# let's load our climate data from our previous lesson:

load("data_output/mauna_loa_met_2001_minute.rda")

library(lubridate, warn.conflicts = F)
library(dplyr, warn.conflicts = F)

# we need to make a datetime column...let's use paste
mloa_2001$datetime <- paste0(mloa_2001$year,"-", mloa_2001$month, "-", mloa_2001$day," ", mloa_2001$hour24, ":", mloa_2001$min) # this makes a character column

# we can nest this within a lubridate function to convert directly to POSIXct
mloa_2001$datetime <- ymd_hm(paste0(mloa_2001$year,"-", mloa_2001$month, "-", mloa_2001$day," ", mloa_2001$hour24, ":", mloa_2001$min))

summary(mloa_2001)

# clean up the NA data (NA's are = -99 or -999 depending on data col)
df <- mloa_2001 %>% 
  filter(!rel_humid == -99, 
         !temp_C_2m == -999,
         !windSpeed_m_s == -99.9)


library(ggplot2)

df %>% sample_n(size=20000) %>% 
  ggplot(.) + 
  geom_point(aes(x=datetime, y=rel_humid, color=temp_C_2m), alpha=0.5) + 
  viridis::scale_color_viridis() + ylim(0, 100)

```



